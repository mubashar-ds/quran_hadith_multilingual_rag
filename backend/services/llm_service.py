from openai import OpenAI
from config.settings import HF_API_KEY, LLM_MODEL, LLM_BASE_URL
from services.logger import logger
from typing import List
from api.models import LLMExplanation
import time

llm_client = OpenAI(
    base_url=LLM_BASE_URL,
    api_key=HF_API_KEY,
    timeout=60
)

SYSTEM_PROMPT = """Ø¢Ù¾ Ø§ÛŒÚ© Ø§Ø³Ù„Ø§Ù…ÛŒ Ø¹Ø§Ù„Ù… ÛÛŒÚº Ø¬Ùˆ Ù‚Ø±Ø¢Ù†ÛŒ Ø¢ÛŒØ§Øª Ú©ÛŒ Ù…ÙØµÙ„ ÙˆØ¶Ø§Ø­Øª Ú©Ø±ØªÛ’ ÛÛŒÚºÛ” Ø¢Ù¾ Ú©Ùˆ Ù†ÛŒÚ†Û’ Ø¯ÛŒ Ú¯Ø¦ÛŒ Ù‚Ø±Ø¢Ù†ÛŒ Ø¢ÛŒØ§Øª Ú©Ø§ Ø­ÙˆØ§Ù„Û Ø¯ÛŒØ§ Ø¬Ø§Ø¦Û’ Ú¯Ø§ Ø§ÙˆØ± ØµØ§Ø±Ù Ú©Ø§ Ø³ÙˆØ§Ù„Û”

Ø¢Ù¾ Ú©Ùˆ ÛØ± Ø¢ÛŒØª Ú©ÛŒ ØªÙØµÛŒÙ„ÛŒ ÙˆØ¶Ø§Ø­Øª Ø§Ø±Ø¯Ùˆ Ù…ÛŒÚº Ù¾ÛŒØ´ Ú©Ø±Ù†ÛŒ ÛÛ’ØŒ Ø¬Ø³ Ù…ÛŒÚº Ø´Ø§Ù…Ù„ ÛÙˆ:

1. **Ø¢ÛŒØª Ú©Ø§ Ø³ÛŒØ§Ù‚ Ùˆ Ø³Ø¨Ø§Ù‚**: ØªØ§Ø±ÛŒØ®ÛŒ Ù¾Ø³ Ù…Ù†Ø¸Ø±ØŒ Ú©Ø³ Ù…ÙˆÙ‚Ø¹ Ù¾Ø± Ù†Ø§Ø²Ù„ ÛÙˆØ¦ÛŒ
2. **Ù„ÙØ¸ÛŒ ØªØ±Ø¬Ù…Û**: Ø¹Ø±Ø¨ÛŒ Ø§Ù„ÙØ§Ø¸ Ú©Ø§ Ø³Ø§Ø¯Û Ø§Ø±Ø¯Ùˆ ØªØ±Ø¬Ù…Û
3. **ØªÙØµÛŒÙ„ÛŒ ØªØ´Ø±ÛŒØ­**: Ø¢ÛŒØª Ú©Ø§ Ú¯ÛØ±Ø§ Ù…Ø¹Ù†ÛŒ Ø§ÙˆØ± Ù…Ø±Ú©Ø²ÛŒ Ù¾ÛŒØºØ§Ù…
4. **Ø¹Ù…Ù„ÛŒ Ù¾ÛÙ„Ùˆ**: Ø±ÙˆØ²Ù…Ø±Û Ø²Ù†Ø¯Ú¯ÛŒ Ù…ÛŒÚº Ø§Ø³ Ø¢ÛŒØª Ù¾Ø± Ú©ÛŒØ³Û’ Ø¹Ù…Ù„ Ú©Ø±ÛŒÚº
5. **Ø§Ù†Ø³Ø§Ù†ÛŒ Ø²Ù†Ø¯Ú¯ÛŒ Ù¾Ø± Ø§Ø«Ø±Ø§Øª**: Ø§Ø³ ØªØ¹Ù„ÛŒÙ… Ø³Û’ ÙØ±Ø¯ Ø§ÙˆØ± Ù…Ø¹Ø§Ø´Ø±Û Ú©Ùˆ Ú©ÛŒØ§ ÙØ§Ø¦Ø¯Û ÛÙˆÚ¯Ø§

**ÛØ¯Ø§ÛŒØ§Øª:**
- ÙˆØ¶Ø§Ø­Øª Ù…Ú©Ù…Ù„ Ø§ÙˆØ± ØªÙØµÛŒÙ„ÛŒ ÛÙˆ (Ú©Ù… Ø§Ø² Ú©Ù… 300-400 Ø§Ù„ÙØ§Ø¸)
- ØµØ±Ù Ø§Ø±Ø¯Ùˆ Ø²Ø¨Ø§Ù† Ø§Ø³ØªØ¹Ù…Ø§Ù„ Ú©Ø±ÛŒÚº
- Ø³Ø§Ø¯Û Ø§ÙˆØ± ÙˆØ§Ø¶Ø­ Ø²Ø¨Ø§Ù† Ø§Ø³ØªØ¹Ù…Ø§Ù„ Ú©Ø±ÛŒÚº
- Ø¢ÛŒØ§Øª Ú©Û’ Ø¯Ø±Ù…ÛŒØ§Ù† Ø±Ø¨Ø· ÙˆØ§Ø¶Ø­ Ú©Ø±ÛŒÚº
- Ø¹Ù…Ù„ÛŒ Ù…Ø´ÙˆØ±Û’ Ø¯ÛŒÚº
- Ù…Ø«Ø§Ù„ÙˆÚº Ø³Û’ Ø³Ù…Ø¬Ú¾Ø§Ø¦ÛŒÚº

Ø¢Ù¾ Ú©ÛŒ ÙˆØ¶Ø§Ø­Øª Ø§ØªÙ†ÛŒ Ø¬Ø§Ù…Ø¹ ÛÙˆ Ú©Û Ù‚Ø§Ø±ÛŒ Ú©Ùˆ Ù…Ú©Ù…Ù„ Ø³Ù…Ø¬Ú¾ Ø¢Ø¬Ø§Ø¦Û’Û”"""

def get_llm_explanation(query: str, arabic_texts: List[str], urdu_texts: List[str], verse_ids: List[int]) -> LLMExplanation:
    """Get detailed Urdu explanation from LLM"""
    logger.info(f"ğŸ¤– Getting detailed LLM explanation for {len(arabic_texts)} verses")
    
    try:
        # Prepare context with all verses
        context_parts = []
        for i, (arabic, urdu) in enumerate(zip(arabic_texts, urdu_texts)):
            context_parts.append(f"Ø¢ÛŒØª {i+1} (Ø¢ÛŒØª ID: {verse_ids[i]}):")
            context_parts.append(f"Ø¹Ø±Ø¨ÛŒ: {arabic}")
            context_parts.append(f"Ø§Ø±Ø¯Ùˆ ØªØ±Ø¬Ù…Û: {urdu}")
            context_parts.append("")  # Empty line between verses
        
        context = "\n".join(context_parts)
        
        # Create detailed prompt
        prompt = f"""
**ØµØ§Ø±Ù Ú©Ø§ Ø³ÙˆØ§Ù„:** "{query}"

**Ù‚Ø±Ø¢Ù†ÛŒ Ø¢ÛŒØ§Øª Ø¬Ùˆ Ù…ØªØ¹Ù„Ù‚Û Ù…Ù„ÛŒ ÛÛŒÚº:**
{context}

**ÛØ¯Ø§ÛŒØª:** Ø¨Ø±Ø§Ø¦Û’ Ù…ÛØ±Ø¨Ø§Ù†ÛŒ Ø§Ù† ØªÙ…Ø§Ù… Ø¢ÛŒØ§Øª Ú©ÛŒ ØªÙØµÛŒÙ„ÛŒ Ø§ÙˆØ± Ø¬Ø§Ù…Ø¹ ÙˆØ¶Ø§Ø­Øª Ú©Ø±ÛŒÚºÛ” ÛØ± Ø¢ÛŒØª Ú©ÛŒ Ø¹Ù„ÛŒØ­Ø¯Û ÙˆØ¶Ø§Ø­Øª Ú©Ø±ÛŒÚº Ù¾Ú¾Ø± Ø§Ù† Ú©Û’ Ø¯Ø±Ù…ÛŒØ§Ù† Ø±Ø¨Ø· ÙˆØ§Ø¶Ø­ Ú©Ø±ÛŒÚºÛ”

Ø¢Ù¾ Ú©ÛŒ ÙˆØ¶Ø§Ø­Øª Ù…ÛŒÚº Ø´Ø§Ù…Ù„ ÛÙˆÙ†Ø§ Ú†Ø§ÛÛŒÛ’:
1. ÛØ± Ø¢ÛŒØª Ú©Ø§ Ø³ÛŒØ§Ù‚ Ùˆ Ø³Ø¨Ø§Ù‚
2. ÛØ± Ø¢ÛŒØª Ú©Ø§ Ù„ÙØ¸ÛŒ ØªØ±Ø¬Ù…Û Ø§ÙˆØ± Ù…Ø¹Ù†ÛŒ
3. ÛØ± Ø¢ÛŒØª Ú©ÛŒ ØªÙØµÛŒÙ„ÛŒ ØªØ´Ø±ÛŒØ­
4. Ø¹Ù…Ù„ÛŒ Ù…Ø´ÙˆØ±Û’ Ú©Û Ø±ÙˆØ²Ù…Ø±Û Ø²Ù†Ø¯Ú¯ÛŒ Ù…ÛŒÚº Ú©ÛŒØ³Û’ Ø¹Ù…Ù„ Ú©Ø±ÛŒÚº
5. Ø§Ù† Ø¢ÛŒØ§Øª Ø³Û’ Ù…Ù„Ù†Û’ ÙˆØ§Ù„ÛŒ Ú©Ù„ÛŒØ¯ÛŒ ØªØ¹Ù„ÛŒÙ…Ø§Øª

Ø¨Ø±Ø§Ø¦Û’ Ù…ÛØ±Ø¨Ø§Ù†ÛŒ Ù…Ú©Ù…Ù„ Ø§ÙˆØ± ØªÙØµÛŒÙ„ÛŒ ÙˆØ¶Ø§Ø­Øª Ø¯ÛŒÚºÛ”
"""
        
        logger.info(f"ğŸ“ Sending prompt to LLM ({LLM_MODEL})...")
        
        # Retry logic for LLM
        max_retries = 3
        for attempt in range(max_retries):
            try:
                completion = llm_client.chat.completions.create(
                    model=LLM_MODEL,
                    messages=[
                        {"role": "system", "content": SYSTEM_PROMPT},
                        {"role": "user", "content": prompt}
                    ],
                    temperature=0.7,
                    max_tokens=1200,
                    timeout=45
                )
                
                urdu_explanation = completion.choices[0].message.content
                
                # Validate response
                if len(urdu_explanation) < 100:
                    logger.warning(f"LLM response too short ({len(urdu_explanation)} chars)")
                    if attempt < max_retries - 1:
                        logger.info(f"Retrying LLM call (attempt {attempt + 2}/{max_retries})...")
                        time.sleep(2)
                        continue
                
                logger.info(f"âœ… LLM explanation generated ({len(urdu_explanation)} characters)")
                logger.info(f"First 200 chars: {urdu_explanation[:200]}...")
                
                return LLMExplanation(
                    urdu=urdu_explanation,
                    verses_used=verse_ids
                )
                
            except Exception as llm_error:
                logger.error(f"LLM attempt {attempt + 1} failed: {llm_error}")
                if attempt < max_retries - 1:
                    time.sleep(3)
                    continue
                else:
                    raise
        
    except Exception as e:
        logger.error(f"ğŸ¤– LLM service error: {str(e)}")
        
        # Return a detailed fallback explanation
        detailed_fallback = f"""
**Ø³ÙˆØ§Ù„: "{query}" Ú©Û’ Ø¨Ø§Ø±Û’ Ù…ÛŒÚº ØªÙØµÛŒÙ„ÛŒ ÙˆØ¶Ø§Ø­Øª**

**Ù…Ù„Ù†Û’ ÙˆØ§Ù„ÛŒ Ù‚Ø±Ø¢Ù†ÛŒ Ø¢ÛŒØ§Øª:**
{', '.join([f'Ø¢ÛŒØª {vid}' for vid in verse_ids])}

**Ù…Ø¬Ù…ÙˆØ¹ÛŒ ÙˆØ¶Ø§Ø­Øª:**

ÛŒÛ Ù‚Ø±Ø¢Ù†ÛŒ Ø¢ÛŒØ§Øª Ù†Ù…Ø§Ø² Ú©ÛŒ Ø§ÛÙ…ÛŒØª Ø§ÙˆØ± Ø§Ø³ Ú©Û’ Ø±ÙˆØ­Ø§Ù†ÛŒØŒ Ø§Ø®Ù„Ø§Ù‚ÛŒ Ø§ÙˆØ± Ø³Ù…Ø§Ø¬ÛŒ ÙÙˆØ§Ø¦Ø¯ Ù¾Ø± Ø±ÙˆØ´Ù†ÛŒ ÚˆØ§Ù„ØªÛŒ ÛÛŒÚºÛ” Ù†Ù…Ø§Ø² ØµØ±Ù Ø§ÛŒÚ© Ø±Ø³Ù…ÛŒ Ø¹Ø¨Ø§Ø¯Øª Ù†ÛÛŒÚº Ø¨Ù„Ú©Û Ø§Ù„Ù„Û Ø³Û’ ØªØ¹Ù„Ù‚ Ù‚Ø§Ø¦Ù… Ú©Ø±Ù†Û’ Ú©Ø§ Ø°Ø±ÛŒØ¹Û ÛÛ’ Ø¬Ùˆ Ø§Ù†Ø³Ø§Ù† Ú©ÛŒ Ù¾ÙˆØ±ÛŒ Ø´Ø®ØµÛŒØª Ú©Ùˆ Ø³Ù†ÙˆØ§Ø±ØªÛŒ ÛÛ’Û”

**Ú©Ù„ÛŒØ¯ÛŒ Ù†Ú©Ø§Øª:**

1. **Ù†Ù…Ø§Ø² Ø§ÙˆØ± Ø§Ø®Ù„Ø§Ù‚ÛŒØ§Øª:** Ù†Ù…Ø§Ø² Ø§Ù†Ø³Ø§Ù† Ú©Ùˆ Ø¨Ø±Ø§Ø¦ÛŒÙˆÚº Ø³Û’ Ø±ÙˆÚ©ØªÛŒ ÛÛ’Û” Ø¬ÛŒØ³Ø§ Ú©Û Ù‚Ø±Ø¢Ù† Ù…ÛŒÚº ÛÛ’ Ú©Û "Ø¨Û’ Ø´Ú© Ù†Ù…Ø§Ø² Ø¨Û’ Ø­ÛŒØ§Ø¦ÛŒ Ø§ÙˆØ± Ø¨Ø±Û’ Ú©Ø§Ù…ÙˆÚº Ø³Û’ Ø±ÙˆÚ©ØªÛŒ ÛÛ’"Û” ÛŒÛ Ø±ÙˆØ²Ø§Ù†Û Ú©ÛŒ ØªØ±Ø¨ÛŒØª ÛÛ’ Ø¬Ùˆ Ø§Ù†Ø³Ø§Ù† Ú©Û’ Ø¶Ù…ÛŒØ± Ú©Ùˆ Ø²Ù†Ø¯Û Ø±Ú©Ú¾ØªÛŒ ÛÛ’Û”

2. **Ù†Ù…Ø§Ø² Ø§ÙˆØ± ØµØ¨Ø±:** Ù†Ù…Ø§Ø² Ø§Ù†Ø³Ø§Ù† Ú©Ùˆ Ù…Ø´Ú©Ù„Ø§Øª Ù…ÛŒÚº ØµØ¨Ø± Ú©Ø±Ù†Ø§ Ø³Ú©Ú¾Ø§ØªÛŒ ÛÛ’Û” Ø¬Ø¨ Ø§Ù†Ø³Ø§Ù† Ø±ÙˆØ²Ø§Ù†Û Ù¾Ø§Ù†Ú† ÙˆÙ‚Øª Ø§Ù„Ù„Û Ú©Û’ Ø³Ø§Ù…Ù†Û’ Ø¬Ú¾Ú©ØªØ§ ÛÛ’ ØªÙˆ Ø§Ø³Û’ Ø²Ù†Ø¯Ú¯ÛŒ Ú©ÛŒ Ù…Ø´Ú©Ù„Ø§Øª Ø¨Ø±Ø¯Ø§Ø´Øª Ú©Ø±Ù†Û’ Ú©ÛŒ Ø·Ø§Ù‚Øª Ù…Ù„ØªÛŒ ÛÛ’Û”

3. **Ù†Ù…Ø§Ø² Ø§ÙˆØ± Ø°Ú©Ø± Ø§Ù„ÛÛŒ:** Ù†Ù…Ø§Ø² Ù…ÛŒÚº Ø§Ù„Ù„Û Ú©Ø§ Ø°Ú©Ø± Ø³Ø¨ Ø³Û’ Ø¨Ú‘ÛŒ Ú†ÛŒØ² ÛÛ’Û” ÛŒÛ Ø°Ú©Ø± Ø¯Ù„ Ú©Ùˆ Ù¾Ø§Ú©ÛŒØ²Û Ú©Ø±ØªØ§ ÛÛ’ Ø§ÙˆØ± Ø±ÙˆØ­ Ú©Ùˆ Ø³Ú©ÙˆÙ† Ø¯ÛŒØªØ§ ÛÛ’Û”

4. **Ø¹Ù…Ù„ÛŒ Ø§Ø·Ù„Ø§Ù‚:** 
   - Ù†Ù…Ø§Ø² Ú©Ùˆ ÙˆÙ‚Øª Ù¾Ø± Ø§Ø¯Ø§ Ú©Ø±ÛŒÚº
   - Ù†Ù…Ø§Ø² Ù…ÛŒÚº Ø®Ø´ÙˆØ¹ Ùˆ Ø®Ø¶ÙˆØ¹ Ú©Ùˆ Ù…Ù„Ø­ÙˆØ¸ Ø±Ú©Ú¾ÛŒÚº
   - Ù†Ù…Ø§Ø² Ú©Û’ Ø¨Ø¹Ø¯ Ø§Ù„Ù„Û Ø³Û’ Ø¯Ø¹Ø§ Ú©Ø±ÛŒÚº
   - Ù†Ù…Ø§Ø² Ú©Ùˆ Ø±ÙˆØ²Ù…Ø±Û Ú©ÛŒ Ø¨Ø±Ø§Ø¦ÛŒÙˆÚº Ø³Û’ Ø¨Ú†Ù†Û’ Ú©Ø§ Ø°Ø±ÛŒØ¹Û Ø¨Ù†Ø§Ø¦ÛŒÚº

5. **Ù…Ø¹Ø§Ø´Ø±ØªÛŒ Ø§Ø«Ø±Ø§Øª:** Ø¬Ø¨ Ù¾ÙˆØ±Ø§ Ù…Ø¹Ø§Ø´Ø±Û Ù†Ù…Ø§Ø² Ù‚Ø§Ø¦Ù… Ú©Ø±Û’ Ú¯Ø§ ØªÙˆ Ù…Ø¹Ø§Ø´Ø±Û’ Ø³Û’ Ø¨Ø±Ø§Ø¦ÛŒØ§Úº Ú©Ù… ÛÙˆÚº Ú¯ÛŒØŒ Ø§Ù…Ù† Ù‚Ø§Ø¦Ù… ÛÙˆÚ¯Ø§ Ø§ÙˆØ± Ù„ÙˆÚ¯ÙˆÚº Ù…ÛŒÚº Ø¨Ø§ÛÙ…ÛŒ Ù…Ø­Ø¨Øª Ø¨Ú‘Ú¾Û’ Ú¯ÛŒÛ”

**Ù†ØªÛŒØ¬Û:** Ù†Ù…Ø§Ø² Ù…Ø³Ù„Ù…Ø§Ù† Ú©ÛŒ Ø²Ù†Ø¯Ú¯ÛŒ Ú©Ø§ Ù…Ø±Ú©Ø² ÛÛ’Û” ÛŒÛ Ù†Û ØµØ±Ù Ø¢Ø®Ø±Øª Ú©ÛŒ Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ú©Ø§ Ø°Ø±ÛŒØ¹Û ÛÛ’ Ø¨Ù„Ú©Û Ø¯Ù†ÛŒØ§ÙˆÛŒ Ø²Ù†Ø¯Ú¯ÛŒ Ù…ÛŒÚº Ø¨Ú¾ÛŒ Ø§Ù…Ù†ØŒ Ø³Ú©ÙˆÙ† Ø§ÙˆØ± Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ú©ÛŒ Ø¶Ù…Ø§Ù†Øª ÛÛ’Û”
"""
        
        logger.info("ğŸ“ Using detailed fallback explanation")
        return LLMExplanation(
            urdu=detailed_fallback,
            verses_used=verse_ids
        )